{% extends "base.html" %}

{% block title %}My Profile - FleetMaster Pro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-person-circle"></i> My Profile</h1>
</div>

<div class="row">
    <!-- Profile Summary Card -->
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Profile Information</h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-3 position-relative d-inline-block">
                    <div class="avatar-circle mx-auto" 
                         style="width: 120px; height: 120px; background: linear-gradient(135deg, #2c3e50, #3498db); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 3rem; color: white; font-weight: bold;">
                            {{ user.name[0] if user.name else 'U' }}{{ user.name.split()[-1][0] if user.name and user.name.split()|length > 1 else '' }}
                        </span>
                    </div>
                    <span class="position-absolute bottom-0 end-0 p-2 bg-success border border-light rounded-circle" style="width: 20px; height: 20px;">
                        <span class="visually-hidden">Online</span>
                    </span>
                </div>
                
                <h4 class="mt-3">{{ user.name if user.name else 'User' }}</h4>
                <p class="text-muted">
                    <i class="bi bi-envelope"></i> {{ user.email if user.email else 'N/A' }}
                </p>
                
                <div class="mb-3">
                    <span class="badge bg-{% if user.role == 'Manager' %}danger{% elif user.role == 'Dispatcher' %}success{% elif user.role == 'Safety Officer' %}warning{% else %}info{% endif %} fs-6 p-2">
                        <i class="bi bi-shield-lock"></i> {{ user.role if user.role else 'User' }}
                    </span>
                </div>
                
                <hr>
                
                <div class="text-start">
                    <p class="mb-2">
                        <i class="bi bi-calendar3 text-primary"></i> 
                        <strong>Member since:</strong> 
                        {{ user.created_at[:10] if user.created_at else 'N/A' }}
                    </p>
                    <p class="mb-2">
                        <i class="bi bi-clock-history text-info"></i> 
                        <strong>Last login:</strong> 
                        {% if user.last_login %}
                            {{ user.last_login[:16] if user.last_login else 'N/A' }}
                        {% else %}
                            <span class="text-muted">First login</span>
                        {% endif %}
                    </p>
                    <p class="mb-2">
                        <i class="bi bi-check-circle text-success"></i> 
                        <strong>Account status:</strong> 
                        <span class="badge bg-success">Active</span>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions Card -->
        <div class="card mt-3 shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary text-start" onclick="scrollToPassword()">
                        <i class="bi bi-key"></i> Change Password
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-info text-start">
                        <i class="bi bi-speedometer2"></i> Go to Dashboard
                    </a>
                    <button class="btn btn-outline-secondary text-start" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print Profile
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Column -->
    <div class="col-md-8">
        <!-- Change Password Card -->
        <div class="card shadow-sm mb-4" id="password-section">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-key"></i> Change Password</h5>
            </div>
            <div class="card-body">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                <i class="bi bi-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <form method="POST" action="{{ url_for('change_password') }}" id="passwordForm">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">
                            <i class="bi bi-lock"></i> Current Password
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="current_password" 
                                   name="current_password" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('current_password')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="new_password" class="form-label">
                            <i class="bi bi-lock"></i> New Password
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="new_password" 
                                   name="new_password" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('new_password')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="password-requirements mt-2 small">
                            <div id="length-check" class="text-muted">
                                <i class="bi bi-x-circle text-danger"></i> At least 6 characters
                            </div>
                            <div id="number-check" class="text-muted">
                                <i class="bi bi-x-circle text-danger"></i> Contains at least one number
                            </div>
                            <div id="uppercase-check" class="text-muted">
                                <i class="bi bi-x-circle text-danger"></i> Contains at least one uppercase letter
                            </div>
                            <div id="special-check" class="text-muted">
                                <i class="bi bi-x-circle text-danger"></i> Contains at least one special character
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">
                            <i class="bi bi-lock-fill"></i> Confirm New Password
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirm_password" 
                                   name="confirm_password" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirm_password')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div id="passwordMatch" class="form-text text-success" style="display: none;">
                            <i class="bi bi-check-circle"></i> Passwords match
                        </div>
                        <div id="passwordMismatch" class="form-text text-danger" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i> Passwords do not match
                        </div>
                    </div>
                    
                    <div class="progress mb-3" style="height: 5px;">
                        <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                        <i class="bi bi-check-circle"></i> Update Password
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Account Activity Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-activity"></i> Account Activity</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-box-arrow-in-right text-success"></i>
                            Last successful login
                        </div>
                        <span class="badge bg-light text-dark">
                            {% if user.last_login %}
                                {{ user.last_login[:16] if user.last_login else 'N/A' }}
                            {% else %}
                                Not available
                            {% endif %}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-calendar-check text-primary"></i>
                            Account created
                        </div>
                        <span class="badge bg-light text-dark">
                            {{ user.created_at[:10] if user.created_at else 'N/A' }}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-shield-check text-info"></i>
                            Security status
                        </div>
                        <span class="badge bg-success">Good</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Security Tips Card -->
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-shield-exclamation"></i> Security Tips</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                Use a unique password
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                Don't share your password
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                Enable 2-factor authentication
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="bi bi-exclamation-circle-fill text-warning"></i>
                                Change password regularly
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-exclamation-circle-fill text-warning"></i>
                                Log out from shared devices
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-exclamation-circle-fill text-warning"></i>
                                Report suspicious activity
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    transition: transform 0.3s;
}
.avatar-circle:hover {
    transform: scale(1.05);
}
.password-requirements {
    font-size: 0.85rem;
    padding-left: 10px;
}
.password-requirements div {
    margin: 2px 0;
}
</style>

<script>
// Toggle password visibility
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const type = field.getAttribute('type') === 'password' ? 'text' : 'password';
    field.setAttribute('type', type);
}

// Scroll to password section
function scrollToPassword() {
    document.getElementById('password-section').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

// Password validation
const newPass = document.getElementById('new_password');
const confirmPass = document.getElementById('confirm_password');
const matchMsg = document.getElementById('passwordMatch');
const mismatchMsg = document.getElementById('passwordMismatch');
const submitBtn = document.getElementById('submitBtn');
const currentPass = document.getElementById('current_password');

// Password strength checkers
const lengthCheck = document.getElementById('length-check');
const numberCheck = document.getElementById('number-check');
const uppercaseCheck = document.getElementById('uppercase-check');
const specialCheck = document.getElementById('special-check');
const strengthBar = document.getElementById('password-strength-bar');

function checkPasswordStrength(password) {
    let strength = 0;
    let requirements = {
        length: password.length >= 6,
        number: /\d/.test(password),
        uppercase: /[A-Z]/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };
    
    // Update requirement checks
    lengthCheck.innerHTML = requirements.length ? 
        '<i class="bi bi-check-circle-fill text-success"></i> At least 6 characters ✓' : 
        '<i class="bi bi-x-circle-fill text-danger"></i> At least 6 characters ✗';
    
    numberCheck.innerHTML = requirements.number ? 
        '<i class="bi bi-check-circle-fill text-success"></i> Contains at least one number ✓' : 
        '<i class="bi bi-x-circle-fill text-danger"></i> Contains at least one number ✗';
    
    uppercaseCheck.innerHTML = requirements.uppercase ? 
        '<i class="bi bi-check-circle-fill text-success"></i> Contains at least one uppercase letter ✓' : 
        '<i class="bi bi-x-circle-fill text-danger"></i> Contains at least one uppercase letter ✗';
    
    specialCheck.innerHTML = requirements.special ? 
        '<i class="bi bi-check-circle-fill text-success"></i> Contains at least one special character ✓' : 
        '<i class="bi bi-x-circle-fill text-danger"></i> Contains at least one special character ✗';
    
    // Calculate strength
    strength = Object.values(requirements).filter(Boolean).length * 25;
    
    // Update strength bar
    strengthBar.style.width = strength + '%';
    strengthBar.className = 'progress-bar';
    
    if (strength < 50) {
        strengthBar.classList.add('bg-danger');
    } else if (strength < 75) {
        strengthBar.classList.add('bg-warning');
    } else {
        strengthBar.classList.add('bg-success');
    }
    
    return requirements;
}

function checkMatch() {
    if (!newPass.value) return;
    
    const requirements = checkPasswordStrength(newPass.value);
    
    if (confirmPass.value.length > 0) {
        if (newPass.value === confirmPass.value) {
            matchMsg.style.display = 'block';
            mismatchMsg.style.display = 'none';
            
            // Enable submit only if all requirements are met and passwords match
            submitBtn.disabled = !(requirements.length && requirements.number && 
                                  requirements.uppercase && requirements.special && 
                                  currentPass.value);
        } else {
            matchMsg.style.display = 'none';
            mismatchMsg.style.display = 'block';
            submitBtn.disabled = true;
        }
    } else {
        matchMsg.style.display = 'none';
        mismatchMsg.style.display = 'none';
        submitBtn.disabled = true;
    }
}

// Also check if current password is filled
if (currentPass) {
    currentPass.addEventListener('keyup', function() {
        checkMatch();
    });
}

if (newPass) {
    newPass.addEventListener('keyup', checkMatch);
}

if (confirmPass) {
    confirmPass.addEventListener('keyup', checkMatch);
}

// Form submission validation
const passwordForm = document.getElementById('passwordForm');
if (passwordForm) {
    passwordForm.addEventListener('submit', function(e) {
        const requirements = checkPasswordStrength(newPass.value);
        
        if (!(requirements.length && requirements.number && requirements.uppercase && requirements.special)) {
            e.preventDefault();
            alert('Please meet all password requirements before submitting.');
        }
        
        if (newPass.value !== confirmPass.value) {
            e.preventDefault();
            alert('Passwords do not match!');
        }
    });
}
</script>
{% endblock %}